<!DOCTYPE html>
<html>
<body>

<div id="input">
  <h3>Installation Guide</h3>

  <p>
    Please read the 
    <a href="https://example.com/docs">official documentation</a> 
    before proceeding.
  </p>

  <p>
    Visit our website at 
    <a href="https://example.com">https://example.com</a> 
    for more details.
  </p>

  <p>
    You can also check the 
    <a href="https://github.com/example/project">GitHub repository</a>.
  </p>

  <ol>
    <li>
      Download the installer from 
      <a href="https://example.com/download">this page</a>.
    </li>
    <li>
      Follow the setup instructions carefully.
    </li>
    <li>
      Contact 
      <a href="mailto:support@example.com">support@example.com</a> 
      if needed.
    </li>
  </ol>

  <p>
    This paragraph contains <b>bold text</b>, 
    <i>italic text</i>, and a 
    <a href="https://example.com/faq">FAQ link</a>.
  </p>
</div>

<br><br>
<button onclick="run()">Run Bookmarklet Logic</button>

<script>

function run() {
  const sel = window.getSelection();
  if (!sel.rangeCount || sel.isCollapsed)
    return alert('No selection!');

  const range = sel.getRangeAt(0);
  const container = document.createElement('div');
  container.appendChild(range.cloneContents());

  let output = '';

  function processNode(node) {
    if (node.nodeType === Node.TEXT_NODE) {
      // Collapse whitespace but preserve single spaces
      const text = node.textContent.replace(/\s+/g, ' ');
      output += text;
    }
    else if (node.nodeType === Node.ELEMENT_NODE) {

      const tag = node.tagName;

      // Block elements â†’ ensure newline boundary
      const blockTags = ['P','DIV','LI','H1','H2','H3','H4','H5','H6','OL','UL'];

      if (blockTags.includes(tag)) {
        output = output.trimEnd() + '\n';
      }

      if (tag === 'A') {
        const text = node.textContent.trim();
        let href = node.getAttribute('href') || '';

        if (href.startsWith('mailto:')) {
          href = href.replace(/^mailto:/, '');
        }

        if (!href || text === href) {
          output += text;
        } else {
          output += `${text}, ${href}`;
        }
      }
      else {
        node.childNodes.forEach(child => processNode(child));
      }

      if (blockTags.includes(tag)) {
        output = output.trimEnd() + '\n';
      }
    }
  }

  container.childNodes.forEach(node => processNode(node));

  // Final cleanup
  output = output
    .replace(/[ \t]+/g, ' ')
    .replace(/\n\s+/g, '\n')   // remove leading space after newline
    .replace(/\n{3,}/g, '\n\n')
    .trim();

  console.log('Final Output:\n' + output);
  navigator.clipboard.writeText(output)
    .then(() => console.log('Selection text with URLs copied!'))
    .catch(err => alert('Copy failed: ' + err));
}
</script>

</body>
</html>
